<template>
    <div class="vueol-collection" style="display: none;">
        <slot :selectFeature="selectFeature" :moveFeature="moveFeature"></slot>
    </div>
</template>
<script>
    import Feature from 'ol/Feature.js';
    import Point from 'ol/geom/Point';
    import { containsCoordinate } from 'ol/extent';

    import { coordinateTransform, deepClone, validCoords, transformStyle } from '../../utils/helpers';
    import eventMixins from '../../mixins/layerEvent';
    import layerMixins from '../../mixins/vectorLayer';

    export default {
        name: 'ol-point-collection',
        mixins: [eventMixins, layerMixins],
        inject: ['getMap'],
        props: {
            points: {
                type: Array,
                default() {
                    return []
                }
            },
            onlyVisible: {   //是否只加载可见视图内的点位;在快速刷新点位的情境下适用，并且点位数量不能太大（几千？）
                type: Boolean,
                default: false
            },
            selectPointId: [String, Number],
            projection: {
                type: String,
                default: 'EPSG:4326'
            }
        },
        data() {
            return {
                layerName: 'collection',
                storeObject: {}
            }
        },
        watch: {
            points: {
                handler() {
                    const vm = this;
                    vm.getMap().then(map => {
                        vm.curClickFeature = null;
                        vm.selectFeature = null;
                        vm.curMoveFeature = null;
                        vm.moveFeature = null;
                        vm.update(map);
                    })
                },
                deep: true
            },
            layerStyle: {
                handler() {
                    if (this.layerStyle) {
                        const style = transformStyle(this.layerStyle);
                        this.layer.setStyle(style);
                    }
                },
                deep: true
            },
            selectPointId: {
                handler(nval) {
                    const vm = this;
                    if (!nval) {
                        vm.selectFeature = null;
                        return false;
                    }
                    let point = vm.storeObject[nval];
                    if (point) {
                        vm.selectFeature = {
                            coords: point.coords,
                            projection: vm.projection,
                            featureInfo: {
                                type: "collection",
                                data: point
                            },
                            collectionInfo: point
                        };
                    } else {
                        vm.selectFeature = null;
                    }
                }
            },
            selectFeature(nval) {
                //双向数据绑定
                // 应用场景：点击列表，地图相应点位点击弹框显示；反之，点击点位，列表对应数据选中
                if (!nval) {
                    this.$emit('update:selectPointId', "");
                } else {
                    this.$emit('update:selectPointId', nval.featureInfo.data.id);
                }
            }
        },
        mounted() {
            this.init();
        },
        methods: {
            init() {
                const vm = this;
                vm.getMap().then((map) => {
                    vm.map = map;
                    vm.createLayer(map, "collectionLayer");

                    vm.storeObject = {};   //以id为键值，存储数据
                    vm.update(map);

                    vm.handleEvent(map);
                    vm.fitView(map);  // 视图范围自适应

                    //加载矢量之后，处理选中状态
                    if (vm.selectPointId) {
                        let point = vm.storeObject[vm.selectPointId];
                        if (point) {
                            vm.selectFeature = deepClone(point);
                        } else {
                            vm.selectFeature = null;
                        }
                    }
                })
            },
            isRepeatId(points) {
                let arr = [];
                for (let value of points) {
                    if (!value.id) {
                        console.error("id缺失：" + JSON.stringify(value));
                        return true;
                    }
                    if (arr.indexOf(value.id) != -1) {
                        let result = points.filter(item => item.id == value.id);
                        console.error("id重复：" + JSON.stringify(result));
                        return true;
                    }
                    arr.push(value.id);
                }
                return false;
            },
            addFeature(point, viewProjection) {
                if (this.projection == "EPSG:4326") {
                    if (!validCoords(point.coords[0], point.coords[1])) {
                        console.error("海量点位 经纬度不规范！", point);
                        return null;
                    }
                }
                let geometry = new Point(point.coords);
                if (this.projection !== 'pixel') {
                    geometry = geometry.transform(this.projection, viewProjection);
                }

                const feature = new Feature({
                    id: point.id,
                    geometry: geometry
                })
                feature.setId(point.id);
                if (point.style) {
                    feature.setStyle(transformStyle(point.style));
                }
                feature.set("featureInfo", {
                    type: "collection",
                    data: point
                });
                feature.set("collectionInfo", point);

                this.storeObject[point.id] = point;
                return feature;
            },
            updateFeature(point, viewProjection) {
                if (this.projection == "EPSG:4326") {
                    if (!validCoords(point.coords[0], point.coords[1])) {
                        console.error("海量点位 经纬度不规范！", point);
                        return false;
                    }
                }
                let f = this.source.getFeatureById(point.id);
                if (f) {
                    let geo = f.getGeometry();
                    let coords = point.coords;
                    if (this.projection !== 'pixel') {
                        coords = coordinateTransform(point.coords, this.projection, viewProjection);
                    }
                    geo.setCoordinates(coords);

                    if (point.style) {
                        f.setStyle(transformStyle(point.style));
                    } else {
                        f.setStyle(null);
                    }
                    f.set("featureInfo", {
                        type: "collection",
                        data: point
                    });
                    f.set("collectionInfo", point);
                    this.storeObject[point.id] = point;
                }
            },
            deleteFeature(id) {
                let f = this.source.getFeatureById(id);
                if (f) {
                    this.source.removeFeature(f);
                    delete this.storeObject[id];
                }
            },
            update(map) {
                const vm = this;
                const viewProjection = map.getView().getProjection().getCode();

                //每个point必须有唯一的id
                if (vm.isRepeatId(vm.points)) {
                    console.error("海量点位必须有唯一的id值");
                    return false;
                }

                const features = new Array();
                const idSet = new Array();
                let extent = map.getView().calculateExtent(map.getSize());
                vm.points.forEach(function (p) {
                    let isIn = true;
                    if (vm.onlyVisible) {
                        //判断是否在可见视图内
                        let coords = p.coords;
                        if (vm.projection !== 'pixel') {
                            coords = coordinateTransform(p.coords, vm.projection, viewProjection);
                        }
                        isIn = containsCoordinate(extent, coords);
                    }
                    if (isIn) {
                        if (vm.storeObject[p.id]) {
                            vm.updateFeature(p, viewProjection);
                        } else {
                            let feature = vm.addFeature(p, viewProjection);
                            if (feature) {
                                features.push(feature);
                            }
                        }
                        idSet.push(p.id+'');  // id为number类型时，强转成string
                    }
                })
                vm.source.addFeatures(features);

                for (let key in vm.storeObject) {
                    if (idSet.indexOf(key) == -1) {
                        vm.deleteFeature(key);
                    }
                }

                vm.$emit("load-finished", {
                    source: vm.source
                })
            }
        }
    }
</script>
