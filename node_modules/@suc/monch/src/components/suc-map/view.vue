<script>
    import View from 'ol/View'
    import {isEqual, coordinateTransform, extentTransform} from '../../utils/helpers'
    import Projection from 'ol/proj/Projection.js';

    export default {
        name: 'ol-view',
        props: {
            /**
             * The center coordinate in the view projection.
             * @type {number[]}
             * @default [0, 0]
             * @vueSync
             */
            center: {
                type: Object,
                default: () => ({
                    'coord': [120, 30],
                    'projection': 'EPSG:4326'
                })
            },
            constrainRotation: {
                type: [Boolean, Number],
                default: true
            },
            enableRotation: {
                type: Boolean,
                default: true
            },
            /**
             * The extent that constrains the view, in other words,
             * nothing outside of this extent can be visible on the map.
             * @default undefined
             */
            extent: {
                type: Array,
                validator: value => value.length === 4
            },
            /**
             * If true, the extent constraint will only apply to the view center and not the whole extent.
             */
            constrainOnlyCenter: {
                type: Boolean,
                default: false
            },
            /**
             * If true, the extent constraint will be applied smoothly,
             * i.e. allow the view to go slightly outside of the given extent.
             */
            smoothExtentConstraint: {
                type: Boolean,
                default: true
            },
            maxResolution: Number,
            minResolution: Number,
            /**
             * @default 28
             */
            maxZoom: {
                type: Number,
                default: 28
            },
            /**
             * @default 0
             */
            minZoom: {
                type: Number,
                default: 0
            },
            /**
             * If false the view is constrained so only one world is visible, and you cannot pan off the edge.
             * If true the map may show multiple worlds at low zoom levels.
             * Only used if the projection is global.
             * Note that if extent is also provided it is given precedence.
             */
            multiWorld: {
                type: Boolean,
                default: false
            },
            constrainResolution: {
                type: Boolean,
                default: false
            },
            smoothResolutionConstraint: {
                type: Boolean,
                default: true
            },
            showFullExtent: {
                type: Boolean,
                default: false
            },
            /**
             * @default EPSG:3857
             */
            projection: {
                type: [String, Object],
                default: 'EPSG:3857'
            },
            resolution: Number,
            resolutions: Array,
            /**
             * The initial rotation for the view in **radians** (positive rotation clockwise).
             * @type {number}
             * @vueSync
             */
            rotation: {
                type: Number,
                default: 0
            },
            /**
             * Zoom level used to calculate the resolution for the view as `int` value. Only used if `resolution` is not defined.
             * @type {number}
             * @default 0
             * @vueSync
             */
            zoom: {
                type: Number,
                default: 6
            },
            /**
             * @default 2
             */
            zoomFactor: {
                type: Number,
                default: 2
            },
            padding: {
                type: Array,
                validator: value => value.length === 4,
                default: () => [0,0,0,0]
            },
        },
        data() {
            return {
                $view: null
            }
        },
        created() {

        },
        watch: {
            center: {
                handler(value) {
                    if (!value.coord) {
                        return;
                    }
                    if (this.$view && !isEqual(value.coord, this.viewCenter)) {
                        if (typeof this.projection == 'object') {
                            /* 这里指pixel
                            * {
                                        code: 'xkcd-image',
                                        units: 'pixels',
                                        extent: [0, 0, 740, 832]
                                    }
                             */
                            if (value.animate) {
                                this.$view.animate({
                                    center: value.coord
                                })
                            } else {
                                this.$view.setCenter(value.coord);
                            }
                        } else {
                            const coord = coordinateTransform(value.coord, value.projection || "EPSG:4326", this.projection);
                            if (value.animate) {
                                this.$view.animate({
                                    center: coord
                                }, {zoom: this.zoom})
                            } else {
                                this.$view.setCenter(coord);
                            }
                        }
                    }
                },
                deep: true
            },
            resolution(value) {
                if (this.$view && value !== this.viewResolution) {
                    this.$view.setResolution(value);
                }
            },
            zoom(value) {
                value = Math.round(value);
                if (this.$view && value !== this.viewZoom) {
                    this.$view.setZoom(value);
                }
            },
            rotation(value) {
                if (this.$view && value !== this.viewRotation) {
                    this.$view.setRotation(value);
                }
            },
            minZoom(value) {
                if (this.$view && value !== this.$view.getMinZoom()) {
                    this.$view.setMinZoom(value);
                }
            },
            maxZoom(value) {
                if (this.$view && value !== this.$view.getMaxZoom()) {
                    this.$view.setMaxZoom(value);
                }
            }
        },
        computed: {
            viewZoom() {
                if (this.$view) {
                    return Math.round(this.$view.getZoom());
                }

                return this.zoom;
            },
            viewRotation() {
                if (this.$view) {
                    return this.$view.getRotation();
                }

                return this.rotation;
            },
            viewResolution() {
                if (this.$view) {
                    return this.$view.getResolution();
                }

                return this.resolution;
            },
            viewCenter() {
                if (this.$view) {
                    let center = this.$view.getCenter();
                    if (typeof this.projection == 'object') {
                        return center;
                    }
                    return coordinateTransform(center, this.projection, this.center.projection || 'EPSG:4326');
                }
            }
        },
        methods: {
            handleCenter() {
                if (!this.center.coord) {
                    return undefined;
                }
                if (typeof this.projection == 'object') {
                    /* 这里指pixel
                    * {
                                code: 'xkcd-image',
                                units: 'pixels',
                                extent: [0, 0, 740, 832]
                            }
                     */
                    return this.center.coord;
                }
                return coordinateTransform(this.center.coord, this.center.projection || "EPSG:4326", this.projection);
            },
            /**
             * @return {ol.View}
             * @protected
             */
            createView() {
                let center = this.handleCenter();
                return new View({
                    center: center,
                    constrainRotation: this.constrainRotation,
                    enableRotation: this.enableRotation,
                    extent: this.extent,
                    constrainOnlyCenter: this.constrainOnlyCenter,
                    smoothExtentConstraint: this.smoothExtentConstraint,
                    maxResolution: this.maxResolution,
                    minResolution: this.minResolution,
                    maxZoom: this.maxZoom,
                    minZoom: this.minZoom,
                    multiWorld: this.multiWorld,
                    constrainResolution: this.constrainResolution,
                    smoothResolutionConstraint: this.smoothResolutionConstraint,
                    showFullExtent: this.showFullExtent,
                    projection: typeof this.projection == 'object' ? new Projection(this.projection) : this.projection,
                    resolution: this.resolution,
                    resolutions: this.resolutions,
                    rotation: this.rotation,
                    zoom: this.zoom,
                    zoomFactor: this.zoomFactor,
                });
            },
            listenViewChange(mapObject) {
                const vm = this;
                mapObject.on('moveend', function () {
                    let coord = vm.$view.getCenter();
                    if (typeof vm.projection != 'object') {
                        coord = coordinateTransform(coord, vm.projection, vm.center.projection || "EPSG:4326");
                    }
                    let center = Object.assign({}, vm.center, {
                        coord
                    })
                    vm.$emit('update:center', center);
                    vm.$emit('update:zoom', vm.$view.getZoom());
                });
                vm.$view.on('change:rotation', function () {
                    vm.$emit('update:rotation', vm.$view.getRotation());
                });
            }
        }
    }
</script>
